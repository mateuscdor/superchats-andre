<script type="text/javascript">

    const socket = io("<%= ip_servidor %>"); //colocar o ip do servidor na porta 3000

    const ip_servidor = "<%= ip_servidor %>";


    function renderMessage(message) {

        console.log(message)

        //fazer o template da mensagem

        let templateYou = `
        <div class='d-flex flex-column align-items-end m-3'>
            <div class="me-3 ms-3 text-light">      ${message.author}</div>
            <div class='d-flex flex-row-reverse align-items-start justify-content-start opcoes-conversa'>
                <div class='fundo-text text-wrap'>
                    ${message.message}
                </div>
                <div class='botoes'>
                    <div class='dropdown'>
                        <i class='fas fa-ellipsis-v dropdown-toggle ms-2 me-2 text-light'
                            data-bs-toggle='dropdown' id='dropdownMenuButton1' aria-expanded='false'></i>

                        <ul class='dropdown-menu' aria-labelledby='dropdownMenuButton1'>
                            <li><i class='fas fa-copy ms-3'></i> Copiar</li>
                            <li><i class='fas fa-star ms-3'></i> Favoritar</li>
                            <li><i class='fas fa-reply ms-3'></i> Responder</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class='me-3 ms-3' style='max-width: 50%;'>
                <span class='text-light' style='margin-top:-10px'>$hora <i
                    class='fas fa-check  '></i></span>
            </div>
        </div>
`;

        let templeteOther = `
                <div class='d-flex flex-column align-items-start m-3'>
                    <div class="me-3 ms-3 text-light">${message.author}</div>
                    <div class='d-flex align-items-start justify-content-start opcoes-conversa'>
                        <div class='fundo-text'>
                            ${message.message}
                        </div>
                        <div class='botoes'>

                            <div class='dropdown'>
                                <i class='fas fa-ellipsis-v dropdown-toggle ms-2 me-2 text-light'
                                    data-bs-toggle='dropdown' id='dropdownMenuButton1' aria-expanded='false'></i>

                                <ul class='dropdown-menu' aria-labelledby='dropdownMenuButton1'>
                                    <li><i class='fas fa-copy ms-3'></i> Copiar</li>
                                    <li><i class='fas fa-star ms-3'></i> Favoritar</li>
                                    <li><i class='fas fa-reply ms-3'></i> Responder</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class='me-3 ms-3' style='max-width: 50%;'>
                        <span class='text-light' style='margin-top:-10px'>$hora <i class='fas fa-check'></i></span>
                    </div>
                </div>
`;

        if (message.author == "<%= conectado %>") {
            $('.mensagens-chat').append(templateYou);
        } else {
            $('.mensagens-chat').append(templeteOther);
        }

        //$('.mensagens-chat').append('<div class="message"><strong>' + message.author + '</strong>: ' + message.message + '</div>');

        var objDiv = document.getElementById("back-chat");
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    socket.on('previousMessages', function (messages) {


        const div = $("#mensagens-chat");
        div.empty();
        for (message of messages) {
            renderMessage(message);
        }
    });

    socket.on('receivedMessage', function (message) {
        renderMessage(message);
    });

    socket.on('wppMessage', function (message) {
        renderMessage(message);
    });

    $('#chat').submit(function (event) {
        event.preventDefault();

        var author = "<%= conectado %>";
        var message = $('input[name=texto]').val();
        var to_number = "<%= destino %>";
        var session = "Marketing";
        var type = "chat";
        //console.log(moment(new Date().getTime()).format("YYYY-MM-DD HH:mm:ss"));
        var created_at = moment(new Date().getTime()).format("YYYY-MM-DD HH:mm:ss");


        if (message.length) {
            var messageObject = {
                author: "<%= conectado %>",
                message: message,
            }

            renderMessage(messageObject);
            socket.emit('sendMessage', messageObject);
        }

        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function () {
            if (this.readyState === 4) {
                console.log(this.responseText);
            }
        });

        xhr.open("POST", `<%= ip_servidor %>/enviar?session=${session}&from_number=${author}&to_number=${to_number}&content=${message}&type=${type}&created_at=${created_at}`);

        xhr.send();
        document.getElementById('buscar').value = '';


    });



</script>

<script type="module" src="assets/js/infoAtendentes.js"></script>
<script type="module" src="assets/js/conversas.js"></script>
<script type="module" src="assets/js/carregarConversas.js"></script>

<script type="text/javascript" src="assets/js/preventF5.js"></script>
<script type="text/javascript" src="assets/js/recarregar-div.js"></script>
<script type="text/javascript" src="assets/js/esconder-botoes.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
    integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
    integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
    crossorigin="anonymous"></script>
<script>
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl)
    })
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.min.js"></script> -->
<!--
<script>
    $('#textarea').emojioneArea({
        pickerPosition: 'top'
    })
</script>
-->
</body>

</html>